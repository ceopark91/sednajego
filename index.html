<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AI자력이탈감지</title>
  <style>
    :root {
      --bg1: #f8f5ee;
      --bg2: #dce5ea;
      --card: rgba(255, 255, 255, 0.9);
      --text: #182026;
      --muted: #5f6a73;
      --accent: #e76f51;
      --accent-2: #2a9d8f;
      --danger: #d62828;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Noto Sans KR", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 80% -10%, #f4c7ab55 10%, transparent 60%),
        radial-gradient(900px 500px at -10% 100%, #8ecae655 10%, transparent 60%),
        linear-gradient(145deg, var(--bg1), var(--bg2));
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 20px;
    }
    .app {
      width: min(760px, 100%);
      background: var(--card);
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.7);
      overflow: hidden;
    }
    .header { padding: 20px 20px 8px; }
    h1 { margin: 0; font-size: clamp(1.3rem, 2.8vw, 1.8rem); }
    .sub { margin-top: 8px; color: var(--muted); font-size: 0.95rem; }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; padding: 8px 20px 14px; }
    button {
      border: 0; border-radius: 12px; padding: 12px 16px; font-weight: 700;
      cursor: pointer; min-width: 120px;
    }
    button:disabled { opacity: 0.45; cursor: not-allowed; }
    #startBtn { background: var(--accent-2); color: white; }
    #stopBtn { background: var(--danger); color: white; }
    .status {
      margin: 0 20px 14px; padding: 12px; border-radius: 10px; background: #f4f7f9;
      color: #334155; font-size: 0.93rem; border-left: 5px solid #93a5b1; white-space: pre-line;
    }
    .status.ok {
      border-left-color: #1f9d77;
      background: #e9f9f3;
      color: #116149;
      font-weight: 700;
    }
    .status.warn { border-left-color: var(--accent); }
    .status.err {
      border-left-color: #d62828;
      background: #fff0f0;
      color: #9f1d1d;
      font-weight: 800;
    }
    .alert-box {
      margin: 0 20px 14px; padding: 12px; border-radius: 10px;
      border: 1px solid #f5c2c2; background: #fff1f1; color: #8a1f1f; font-weight: 700; display: none;
    }
    .alert-box.active {
      display: block;
      border-color: #e03131;
      background: #ffe3e3;
      color: #a51111;
      box-shadow: 0 0 0 2px #ffc9c9 inset;
    }
    .main-result {
      margin: 0 20px 12px; padding: 14px; border-radius: 12px;
      background: #fff; border: 1px solid #dde4ea; display: grid; gap: 6px;
    }
    .track {
      margin: 0 20px 12px; background: #fff; border: 1px solid #dde4ea;
      border-radius: 10px; padding: 10px 12px; font-size: 0.9rem;
    }
    .track-row {
      display: flex; justify-content: space-between; align-items: center; gap: 10px;
      margin-bottom: 8px; font-variant-numeric: tabular-nums;
    }
    .track-bar-bg { width: 100%; height: 10px; background: #edf2f7; border-radius: 999px; overflow: hidden; }
    .track-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ff8f00, #d62828); transition: width 0.12s linear; }
    .list { display: grid; gap: 10px; margin: 0; padding: 0 20px 20px; list-style: none; }
    .item { background: #fff; border-radius: 10px; border: 1px solid #e2e8ee; overflow: hidden; }
    .row { display: flex; justify-content: space-between; gap: 10px; padding: 10px 12px 8px; font-size: 0.95rem; }
    .bar-bg { width: 100%; height: 10px; background: #edf2f7; }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ff8f00, #e76f51); transition: width 0.12s linear; }
    .hint { margin: 0 20px 20px; color: var(--muted); font-size: 0.88rem; }
    code { background: #f2f5f8; padding: 1px 5px; border-radius: 5px; font-family: Consolas, monospace; }
  </style>
</head>
<body>
  <section class="app">
    <div class="header">
      <h1>AI자력이탈감지</h1>
      <div class="sub">로컬 모델 파일(<code>model.json</code>, <code>metadata.json</code>, <code>weights.bin</code>)로 동작합니다.</div>
      <div class="sub" id="modelInfo">모델 정보: 로딩 전</div>
    </div>

    <div class="controls">
      <button id="startBtn">마이크 시작</button>
      <button id="stopBtn" disabled>중지</button>
    </div>

    <div id="status" class="status">대기 중</div>
    <div id="alertBox" class="alert-box">자력이탈 경고: 2.0초 누적 70% 기준 충족</div>

    <div class="main-result">
      <div id="topLabel">예측 없음</div>
      <div id="topConfidence">신뢰도: 0%</div>
    </div>

    <div class="track">
      <div class="track-row">
        <strong>자력이탈 연속 감지</strong>
        <span id="trackText">0.0 / 2.0초 (기준 70%)</span>
      </div>
      <div class="track-bar-bg"><div id="trackBar" class="track-bar"></div></div>
    </div>

    <div class="track">
      <div class="track-row">
        <strong>자력이탈 감지 횟수</strong>
        <span id="alertCount">0 회</span>
      </div>
    </div>

    <ul id="resultList" class="list"></ul>

    <div class="hint">예: <code>python app.py</code> 또는 <code>run_ai_detection.bat</code></div>
  </section>

  <script src="./libs/tf.min.js"></script>
  <script src="./libs/speech-commands.min.js"></script>
  <script>
  const CACHE_BUST = Date.now().toString();
  const MODEL_URL_OBJ = new URL("./model.json", window.location.href);
  const METADATA_URL_OBJ = new URL("./metadata.json", window.location.href);
  MODEL_URL_OBJ.searchParams.set("t", CACHE_BUST);
  METADATA_URL_OBJ.searchParams.set("t", CACHE_BUST);

  const MODEL_URL = MODEL_URL_OBJ.href;
  const METADATA_URL = METADATA_URL_OBJ.href;

  const DECISION_THRESHOLD = 0.55;
  const ALERT_LABEL_NAME = "자력이탈";
  const MOTOR_LABEL_NAME = "모터구동";
  const ALERT_SCORE_THRESHOLD = 0.7;
  const ALERT_HOLD_MS = 2000;
  const ALERT_COOLDOWN_MS = 2500;

  let recognizer;
  let labels = [];
  let labelKeys = [];
  let alertTargetIndex = -1;
  let alertAccumMs = 0;
  let lastTickAt = null;
  let alertRaised = false;
  let alertCount = 0;
  let inCooldownUntil = 0;

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const statusEl = document.getElementById("status");
  const alertBoxEl = document.getElementById("alertBox");
  const listEl = document.getElementById("resultList");
  const topLabelEl = document.getElementById("topLabel");
  const topConfidenceEl = document.getElementById("topConfidence");
  const trackTextEl = document.getElementById("trackText");
  const trackBarEl = document.getElementById("trackBar");
  const alertCountEl = document.getElementById("alertCount");
  const modelInfoEl = document.getElementById("modelInfo");

  function setStatus(text, kind = "") {
    statusEl.textContent = text;
    statusEl.className = "status" + (kind ? " " + kind : "");
  }

  function setModelInfo(text) {
    if (modelInfoEl) modelInfoEl.textContent = text;
  }

  function ensureLibs() {
    if (!window.tf || !window.speechCommands) {
      throw new Error("라이브러리 파일이 없습니다. ./libs/tf.min.js 와 ./libs/speech-commands.min.js 를 넣어주세요.");
    }
  }

  function toKey(label, index) {
    const safe = (label || "").replace(/[^0-9a-zA-Z\u3131-\u318E\uAC00-\uD7A3]+/g, "_");
    return `${index}_${safe}`;
  }

  function renderRows(classNames) {
    listEl.innerHTML = "";
    labelKeys = classNames.map((name, idx) => toKey(name, idx));
    classNames.forEach((name, idx) => {
      const key = labelKeys[idx];
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `<div class="row"><strong>${name}</strong><span id="pct-${key}">0%</span></div><div class="bar-bg"><div id="bar-${key}" class="bar"></div></div>`;
      listEl.appendChild(li);
    });
  }

  function resolveAlertTargetIndex() {
    const exact = labels.findIndex((x) => x === ALERT_LABEL_NAME);
    if (exact >= 0) return exact;
    return labels.findIndex((x) => (x || "").includes(ALERT_LABEL_NAME));
  }

  function renderAlertCount() {
    alertCountEl.textContent = `${alertCount} 회`;
  }

  function resetAlertTracking() {
    alertAccumMs = 0;
    lastTickAt = null;
    alertRaised = false;
    inCooldownUntil = 0;
    trackBarEl.style.width = "0%";
    trackTextEl.textContent = `0.0 / ${(ALERT_HOLD_MS / 1000).toFixed(1)}초 (기준 ${(ALERT_SCORE_THRESHOLD * 100).toFixed(0)}%)`;
    alertBoxEl.classList.remove("active");
  }

  function updateAlertTracking(targetScore) {
    const now = Date.now();
    const dt = Math.min(300, lastTickAt === null ? 0 : now - lastTickAt);
    lastTickAt = now;

    if (targetScore >= ALERT_SCORE_THRESHOLD) {
      alertAccumMs += dt;
    } else if (targetScore >= ALERT_SCORE_THRESHOLD - 0.1) {
      alertAccumMs += dt * 0.25;
    } else {
      alertAccumMs -= dt * 0.7;
    }

    if (alertAccumMs < 0) alertAccumMs = 0;
    if (alertAccumMs > ALERT_HOLD_MS) alertAccumMs = ALERT_HOLD_MS;

    const progress = Math.min(1, alertAccumMs / ALERT_HOLD_MS);
    trackBarEl.style.width = `${(progress * 100).toFixed(1)}%`;
    trackTextEl.textContent = `${(alertAccumMs / 1000).toFixed(1)} / ${(ALERT_HOLD_MS / 1000).toFixed(1)}초 (기준 ${(ALERT_SCORE_THRESHOLD * 100).toFixed(0)}%)`;

    const cooldownActive = now < inCooldownUntil;
    if (alertAccumMs >= ALERT_HOLD_MS && !alertRaised && !cooldownActive) {
      alertRaised = true;
      inCooldownUntil = now + ALERT_COOLDOWN_MS;
      alertCount += 1;
      renderAlertCount();
      alertBoxEl.classList.add("active");
    }

    if (alertAccumMs <= ALERT_HOLD_MS * 0.2 && !cooldownActive) {
      alertRaised = false;
      alertBoxEl.classList.remove("active");
    }

    return alertBoxEl.classList.contains("active") || cooldownActive;
  }

  function updatePrediction(scores) {
    let maxIdx = 0;
    for (let i = 1; i < scores.length; i++) {
      if (scores[i] > scores[maxIdx]) maxIdx = i;
    }

    const top = scores[maxIdx] || 0;
    const topName = labels[maxIdx] || "알 수 없음";
    const decided = top >= DECISION_THRESHOLD;
    topLabelEl.textContent = decided ? `판정: ${topName}` : `판정 대기 (${topName})`;
    topConfidenceEl.textContent = `신뢰도: ${(top * 100).toFixed(1)}% (임계값 ${(DECISION_THRESHOLD * 100).toFixed(0)}%)`;

    for (let i = 0; i < scores.length; i++) {
      const pct = Math.max(0, Math.min(100, (scores[i] || 0) * 100));
      const key = labelKeys[i];
      const bar = document.getElementById(`bar-${key}`);
      const pctEl = document.getElementById(`pct-${key}`);
      if (bar) bar.style.width = `${pct.toFixed(1)}%`;
      if (pctEl) pctEl.textContent = `${pct.toFixed(1)}%`;
    }

    const targetScore = alertTargetIndex >= 0 ? (scores[alertTargetIndex] || 0) : 0;
    const isAlert = updateAlertTracking(targetScore);

    if (isAlert) {
      setStatus("자력이탈 경고: 누적 조건 충족", "err");
    } else if (topName === MOTOR_LABEL_NAME && top >= DECISION_THRESHOLD) {
      setStatus(`모터 정상운행중 (${(top * 100).toFixed(1)}%)`, "ok");
    } else {
      setStatus("분석 중", "warn");
    }
  }

  async function startListening() {
    try {
      ensureLibs();
      startBtn.disabled = true;
      setStatus("모델 로딩 중...", "warn");

      recognizer = window.speechCommands.create("BROWSER_FFT", undefined, MODEL_URL, METADATA_URL);
      await recognizer.ensureModelLoaded();

      const metadataObj = await (await fetch(METADATA_URL, { cache: "no-store" })).json();
      setModelInfo(`모델 timeStamp: ${metadataObj.timeStamp || "없음"} / labels: ${(metadataObj.wordLabels || []).join(", ")}`);

      labels = recognizer.wordLabels();
      renderRows(labels);

      alertTargetIndex = resolveAlertTargetIndex();
      alertCount = 0;
      renderAlertCount();
      resetAlertTracking();

      recognizer.listen(
        (result) => updatePrediction(Array.from(result.scores || [])),
        {
          overlapFactor: 0.75,
          probabilityThreshold: 0,
          invokeCallbackOnNoiseAndUnknown: true,
          includeSpectrogram: true
        }
      );

      stopBtn.disabled = false;
      setStatus("분석 중", "warn");
    } catch (err) {
      startBtn.disabled = false;
      stopBtn.disabled = true;
      setStatus("실패: " + (err && err.message ? err.message : String(err)), "err");
    }
  }

  function stopListening() {
    if (recognizer) recognizer.stopListening();
    stopBtn.disabled = true;
    startBtn.disabled = false;
    resetAlertTracking();
    setStatus("중지됨", "warn");
  }

  startBtn.addEventListener("click", startListening);
  stopBtn.addEventListener("click", stopListening);
  setStatus("준비됨: [마이크 시작] 버튼을 눌러주세요.", "warn");
</script>
</body>
</html>



